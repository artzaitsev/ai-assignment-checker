services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: app
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U app -d app"]
      interval: 5s
      timeout: 3s
      retries: 10

  migrator:
    image: migrate/migrate:v4.18.1
    command: [
      "-path",
      "/migrations",
      "-database",
      "postgres://app:app@postgres:5432/app?sslmode=disable",
      "up"
    ]
    volumes:
      - ./db/migrations:/migrations:ro
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  api:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["uv", "run", "python", "-m", "app.main", "--role", "api", "--port", "8000"]
    depends_on:
      postgres:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
    ports:
      - "8000:8000"

  worker-ingest-telegram:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["uv", "run", "python", "-m", "app.main", "--role", "worker-ingest-telegram", "--port", "8101"]
    depends_on:
      postgres:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully

  worker-normalize:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["uv", "run", "python", "-m", "app.main", "--role", "worker-normalize", "--port", "8102"]
    depends_on:
      postgres:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully

  worker-llm:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["uv", "run", "python", "-m", "app.main", "--role", "worker-llm", "--port", "8103"]
    depends_on:
      postgres:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully

  worker-deliver:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["uv", "run", "python", "-m", "app.main", "--role", "worker-deliver", "--port", "8104"]
    depends_on:
      postgres:
        condition: service_healthy
      migrator:
        condition: service_completed_successfully
